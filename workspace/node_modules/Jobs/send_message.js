//By jarij 
//last time modificated: 8.3.17

const assert = require('assert');
 
 function sendMessage(db, post, callback)
 {
        db.collection('message').save(post["message"], {
            w: 0
        }, function(err, result) 
        {
            assert.equal(err, null);
            var finder={};
            finder[GLOBAL.userName] = post['message']['resipient'];
            var cursor = db.collection('user').findOne(finder,function(err, user) 
            {
                assert.equal(err, null);
                if (user != null) 
                {
                    //conversations=user.conversations;
                    var conversationFound=false;
                    var conversations= user['conversations'];
                    for(var i=0; i < conversations.length&&!conversationFound;i++)
                    {
                        var conversation=conversations[i];
                        if(conversation['other'] == post['message']['sender'])
                        {
                            conversationFound = true;
                            db.close();     
                        }
                    }
                    if(conversationFound===false)
                    {
                        
                        var conversation = {'owner': post['message']['resipient'],'other': post['message']['sender']};
                        user['conversations'].push(conversation);
                        db.collection('user').save(user,{
                            w:1
                        },function(err, result)
                        {
                            assert.equal(err, null);
                            db.close();
                        });
                    }
                   // db.close();
                    return callback("sent message");
                    
                }else{
                    return callback("user not found");
                }
            });
            
        
        });
    
}

module.exports = sendMessage