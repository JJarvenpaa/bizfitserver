// By jarij, 
//last time modificated: 8.3.17
const assert = require('assert');

function getMessageIncoming(db, post, callback)
{
    var object;
    var messageArray=[];
    //TODO haku toistenp√§in
    //var finder={function() { return (this.resipient == post['owner'] && this.sender==post['other'] ) } };
    //var finder={'&and':[{'resipient':{'&eq' :post['owner']}},{'sender':{'&eq' :post['other']}}]};
    var finder={'resipient':post['owner']};
    var cursor = db.collection('message').find(finder);
    cursor.each(function(err, doc) 
    {
        assert.equal(err, null);
        if (doc != null) 
        {
            //var jotain={'user':doc};
    
            if(post["creationTime"]<doc["creationTime"] && post["other"] == doc["sender"]){
                messageArray.push(JSON.stringify(doc));
            }else{
                //array.push(JSON.stringify(doc)); // for testing only
            }
        }
        else 
        {                  
            var text=JSON.stringify(messageArray);
            db.close();     
            if(typeof text != 'undefined')
            {
                return callback(text);
            }
            else
            {
                return callback("Couldn't get incoming messages");
            }
        };
                      
    });
        

};

module.exports = getMessageIncoming;